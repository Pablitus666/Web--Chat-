name: Limpieza de Salas Inactivas

on:
  # Ejecuta el workflow cada hora
  schedule:
    - cron: '*/10 * * * *'
  # Permite ejecutar este workflow manualmente desde la pestaña Actions en GitHub
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v3

      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18' # Usamos una versión LTS de Node.js
          cache: 'npm'

      - name: Instalar dependencias
        run: npm install

      # Paso para decodificar el archivo JSON de la cuenta de servicio de Firebase
      # El secreto FIREBASE_SERVICE_ACCOUNT_BASE64 debe contener el contenido
      # en Base64 de tu archivo JSON de credenciales de Firebase.
      - name: Decodificar credenciales de Firebase
        run: echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_BASE64 }}" | base64 --decode > ${{ runner.temp }}/serviceAccountKey.json

      - name: Ejecutar script de limpieza
        env:
          # Apunta a las credenciales decodificadas
          GOOGLE_APPLICATION_CREDENTIALS: ${{ runner.temp }}/serviceAccountKey.json
        run: |
          # La URL de tu base de datos debe estar aquí.
          # Búscala en tu consola de Firebase -> Realtime Database.
          # Debería ser algo como https://TU-PROYECTO-12345-default-rtdb.firebaseio.com
          DATABASE_URL="https://web-chat-a81d1-default-rtdb.firebaseio.com"
          
          echo "Ejecutando limpieza para la base de datos: $DATABASE_URL"
          node cleanup-rooms.js "$DATABASE_URL"
